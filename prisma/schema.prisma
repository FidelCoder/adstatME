// This is your Prisma schema file
// Learn more: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// ENUMS
// ============================================

enum UserRole {
  USER
  BRAND
  ADMIN
}

enum UserTier {
  BRONZE
  SILVER
  GOLD
  PLATINUM
}

enum CampaignStatus {
  DRAFT
  ACTIVE
  PAUSED
  COMPLETED
  CANCELLED
}

enum PostStatus {
  PENDING
  VERIFIED
  REJECTED
  PAID
}

enum PayoutStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

enum PayoutMethod {
  NEXUSPAY
  MPESA
  PAYSTACK
  BANK
}

// ============================================
// MODELS
// ============================================

model User {
  id              String    @id @default(uuid())
  phoneNumber     String    @unique @map("phone_number")
  whatsappVerified Boolean  @default(false) @map("whatsapp_verified")
  walletAddress   String?   @map("wallet_address")
  
  // Profile
  name            String?
  ageRange        String?   @map("age_range")
  locationCity    String?   @map("location_city")
  locationCountry String?   @map("location_country")
  interests       String[]
  
  // Stats
  contactCount         Int      @default(0) @map("contact_count")
  campaignsCompleted   Int      @default(0) @map("campaigns_completed")
  totalViews           Int      @default(0) @map("total_views")
  totalReshares        Int      @default(0) @map("total_reshares")
  totalEarned          Decimal  @default(0) @db.Decimal(10, 2) @map("total_earned")
  
  // Reputation
  role            UserRole   @default(USER)
  tier            UserTier   @default(BRONZE)
  reputationScore Decimal    @default(1.0) @db.Decimal(3, 2) @map("reputation_score")
  avgViewRate     Decimal?   @db.Decimal(3, 2) @map("avg_view_rate")
  fraudFlags      Int        @default(0) @map("fraud_flags")
  isBanned        Boolean    @default(false) @map("is_banned")
  
  // Device tracking
  deviceFingerprint String?  @map("device_fingerprint")
  
  // Timestamps
  createdAt     DateTime   @default(now()) @map("created_at")
  updatedAt     DateTime   @updatedAt @map("updated_at")
  lastActive    DateTime?  @map("last_active")
  deletedAt     DateTime?  @map("deleted_at")
  
  // Relations
  posts         Post[]
  reshares      Reshare[]
  payouts       Payout[]
  referredBy    User?      @relation("Referrals", fields: [referrerId], references: [id])
  referrerId    String?    @map("referrer_id")
  referrals     User[]     @relation("Referrals")
  
  @@map("users")
  @@index([phoneNumber])
  @@index([locationCountry, locationCity])
  @@index([tier])
  @@index([role])
}

model Brand {
  id          String   @id @default(uuid())
  name        String
  email       String   @unique
  company     String?
  apiKey      String?  @unique @map("api_key")
  
  // Balance
  balance     Decimal  @default(0) @db.Decimal(10, 2)
  totalSpent  Decimal  @default(0) @db.Decimal(10, 2) @map("total_spent")
  
  // Stats
  totalCampaigns    Int  @default(0) @map("total_campaigns")
  totalImpressions  Int  @default(0) @map("total_impressions")
  
  // Timestamps
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  deletedAt   DateTime? @map("deleted_at")
  
  // Relations
  campaigns   Campaign[]
  
  @@map("brands")
  @@index([email])
}

model Campaign {
  id          String   @id @default(uuid())
  brandId     String   @map("brand_id")
  
  // Campaign details
  name        String
  description String?  @db.Text
  creativeUrl String   @map("creative_url")
  watermarkId String   @unique @map("watermark_id")
  callToAction String? @map("call_to_action")
  
  // Targeting
  targetLocations   String[]  @map("target_locations")
  targetAgeRanges   String[]  @map("target_age_ranges")
  targetInterests   String[]  @map("target_interests")
  minContacts       Int?      @map("min_contacts")
  minViewRate       Decimal?  @db.Decimal(3, 2) @map("min_view_rate")
  
  // Budget
  totalBudget       Decimal   @db.Decimal(10, 2) @map("total_budget")
  spentBudget       Decimal   @default(0) @db.Decimal(10, 2) @map("spent_budget")
  cpm               Decimal   @db.Decimal(10, 2) // Cost per 1000 views (brand pays)
  userCpm           Decimal   @db.Decimal(10, 2) @map("user_cpm") // What users get paid
  flatFee           Decimal   @default(0) @db.Decimal(10, 2) @map("flat_fee")
  reshareBonus      Decimal   @default(0) @db.Decimal(10, 2) @map("reshare_bonus")
  
  // Limits
  maxPosters          Int      @map("max_posters")
  targetImpressions   Int      @map("target_impressions")
  currentImpressions  Int      @default(0) @map("current_impressions")
  
  // Status
  status      CampaignStatus  @default(DRAFT)
  startDate   DateTime?       @map("start_date")
  endDate     DateTime?       @map("end_date")
  
  // Timestamps
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  deletedAt   DateTime? @map("deleted_at")
  
  // Relations
  brand       Brand    @relation(fields: [brandId], references: [id])
  posts       Post[]
  
  @@map("campaigns")
  @@index([brandId])
  @@index([status])
  @@index([startDate, endDate])
}

model Post {
  id          String   @id @default(uuid())
  userId      String   @map("user_id")
  campaignId  String   @map("campaign_id")
  
  // Verification data
  screenshotUrl       String?   @map("screenshot_url")
  viewsCount          Int?      @map("views_count")
  resharesCount       Int?      @map("reshares_count")
  postedAt            DateTime? @map("posted_at")
  screenshotUploadedAt DateTime? @map("screenshot_uploaded_at")
  
  // Verification status
  status              PostStatus  @default(PENDING)
  verifiedBy          String?     @map("verified_by") // 'auto', 'manual', 'audit'
  verificationNotes   String?     @db.Text @map("verification_notes")
  
  // Earnings
  baseEarnings        Decimal  @default(0) @db.Decimal(10, 2) @map("base_earnings")
  bonusEarnings       Decimal  @default(0) @db.Decimal(10, 2) @map("bonus_earnings")
  totalEarnings       Decimal  @default(0) @db.Decimal(10, 2) @map("total_earnings")
  
  // Metadata
  isReshare           Boolean  @default(false) @map("is_reshare")
  originalPostId      String?  @map("original_post_id")
  deviceFingerprint   String?  @map("device_fingerprint")
  
  // Timestamps
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  
  // Relations
  user        User      @relation(fields: [userId], references: [id])
  campaign    Campaign  @relation(fields: [campaignId], references: [id])
  originalPost Post?    @relation("Reshares", fields: [originalPostId], references: [id])
  reshares    Post[]    @relation("Reshares")
  resharesData Reshare[]
  
  @@map("posts")
  @@index([userId, campaignId])
  @@index([status])
  @@index([createdAt])
}

model Reshare {
  id              String   @id @default(uuid())
  originalPostId  String   @map("original_post_id")
  resharedByUserId String  @map("reshared_by_user_id")
  resharePostId   String   @map("reshare_post_id")
  
  viewsCount           Int      @map("views_count")
  originalPosterBonus  Decimal  @db.Decimal(10, 2) @map("original_poster_bonus")
  
  createdAt   DateTime @default(now()) @map("created_at")
  
  // Relations
  originalPost Post @relation(fields: [originalPostId], references: [id])
  resharedBy   User @relation(fields: [resharedByUserId], references: [id])
  
  @@map("reshares")
  @@index([originalPostId])
  @@index([resharedByUserId])
}

model Payout {
  id          String   @id @default(uuid())
  userId      String   @map("user_id")
  
  amount      Decimal  @db.Decimal(10, 2)
  currency    String   @default("USDT")
  method      PayoutMethod
  
  // Crypto specific
  walletAddress       String?  @map("wallet_address")
  transactionHash     String?  @map("transaction_hash")
  network             String?  // 'polygon', 'ethereum', etc.
  
  // Mobile money specific
  phoneNumber         String?  @map("phone_number")
  
  // Status
  status      PayoutStatus  @default(PENDING)
  processedAt DateTime?     @map("processed_at")
  failureReason String?     @db.Text @map("failure_reason")
  
  // Related posts
  postIds     String[]      @map("post_ids")
  
  // Timestamps
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  
  // Relations
  user        User     @relation(fields: [userId], references: [id])
  
  @@map("payouts")
  @@index([userId])
  @@index([status])
  @@index([createdAt])
}

model RefreshToken {
  id          String   @id @default(uuid())
  token       String   @unique
  userId      String   @map("user_id")
  expiresAt   DateTime @map("expires_at")
  
  createdAt   DateTime @default(now()) @map("created_at")
  
  @@map("refresh_tokens")
  @@index([userId])
  @@index([token])
}


